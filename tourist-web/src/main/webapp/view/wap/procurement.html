<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta name="viewport"
          content="width=device-width,minimum-scale=1,user-scalable=no,maximum-scale=1,initial-scale=1"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" content=""/>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" type="text/css" href="http://resali.huobanplus.com/cdn/jquery-weui/0.8.2/weui.min.css">
    <link rel="stylesheet" type="text/css"
          href="http://resali.huobanplus.com/cdn/jquery-weui/0.8.2/jquery-weui.min.css">
    <link rel="stylesheet" type="text/css" href="../../assets/css/weui.min-xzlx-diy.css">
    <title>立即采购</title>
</head>

<body class="bac">
<div class="weui_cells_title"> 采购信息</div>
<div class="content" style="background-color: #fff; padding:8px;">
    <div class="number-control" style="margin:0px 20px;">
        <p style="float: left; margin-top:3px;">成人：</p>
        <div class="mui-number" style="float: right">
            <button type="button" class="decrease disabled priceDecrease">-</button>
            <input type="number" readonly class="num" value="0" min="0" max="205" step="" name="adult">
            <button type="button" class="increase priceIncrease">+</button>
        </div>
    </div>
    <p style="clear: both;"></p>
</div>
<div class="content" style="background-color: #fff; padding:8px;border-top:1px solid #ececec;">
    <div class="number-control" style="margin:0px 20px;">
        <p style="float: left; margin-top:3px;">儿童：</p>
        <div class="mui-number" style="float: right">
            <button type="button" class="decrease disabled childPriceDecrease">-</button>
            <input type="number" readonly class="num" value="0" min="0" max="205" step="" name="children">
            <button type="button" class="increase childPriceIncrease">+</button>
        </div>
    </div>
    <p style="clear: both;"></p>
</div>
<div class="content" style="background-color: #fff; padding:8px;border-top:1px solid #ececec;">
    <div class="number-control" style="margin:0px 20px;">
        <p style="float: left; margin-top:3px;">采购价格：</p>
        <p style="float:right;color:#FF5558;" class="money">￥0.00</p>
    </div>
    <p style="clear: both;"></p>
</div>
<div class="items">
    <!--<div class="item adultDiv">-->
    <!--<div class="weui_cells_title"> 请填写人员正确信息-->
    <!--<img src="../../assets/img/ddd.png"-->
    <!--style="width: 17px;float: right;vertical-align: middle;" class="delete">-->
    <!--</div>-->
    <!--<div class="weui_cells weui_cells_form">-->
    <!--<div class="weui_cell">-->
    <!--<div class="weui_cell_bd weui_cell_primary">-->
    <!--<input type="hidden" class="travelerType" name="travelerType" value="0">-->
    <!--<input class="weui_input" type="text" name="name" placeholder="姓名">-->
    <!--</div>-->
    <!--</div>-->
    <!--<div class="weui_cell">-->
    <!--<div class="weui_cell_bd weui_cell_primary">-->
    <!--<input class="weui_input" type="tel" name="telPhone" placeholder="手机号">-->
    <!--</div>-->
    <!--</div>-->
    <!--<div class="weui_cell">-->
    <!--<div class="weui_cell_bd weui_cell_primary">-->
    <!--<input class="weui_input" type="text" name="IDNo" placeholder="身份证">-->
    <!--</div>-->
    <!--</div>-->
    <!--<div class="weui_cell">-->
    <!--<div class="weui_cell_bd weui_cell_primary">-->
    <!--<input class="weui_input" type="number" name="age" placeholder="年龄">-->
    <!--</div>-->
    <!--</div>-->
    <!--<div class="weui_cell weui_cell_select">-->
    <!--<div class="weui_cell_bd weui_cell_primary">-->
    <!--<select class="weui_select" name="sex" style="color:#a9a9a9;">-->
    <!--<option selected="" value="0">男</option>-->
    <!--<option value="1">女</option>-->
    <!--</select>-->
    <!--</div>-->
    <!--</div>-->

    <!--</div>-->
    <!--</div>-->
</div>
<div class="itemTemplate item " style="display: none">
    <div class="weui_cells_title"> 请填写人员正确信息
        <img src="../../assets/img/ddd.png"
             style="width: 17px;float: right;vertical-align: middle;" class="delete">
    </div>
    <div class="weui_cells weui_cells_form">
        <div class="weui_cell">
            <div class="weui_cell_bd weui_cell_primary">
                <input type="hidden" class="travelerType" name="travelerType" value="0">
                <input class="weui_input" type="text" name="name" placeholder="姓名">
            </div>
        </div>
        <div class="weui_cell">
            <div class="weui_cell_bd weui_cell_primary">
                <input class="weui_input" type="tel" name="telPhone" placeholder="手机号">
            </div>
        </div>
        <div class="weui_cell">
            <div class="weui_cell_bd weui_cell_primary">
                <input class="weui_input" type="text" name="IDNo" placeholder="身份证">
            </div>
        </div>
        <div class="weui_cell">
            <div class="weui_cell_bd weui_cell_primary">
                <input class="weui_input" type="number" name="age" placeholder="年龄">
            </div>
        </div>
        <div class="weui_cell weui_cell_select">
            <div class="weui_cell_bd weui_cell_primary">
                <select class="weui_select" name="sex" style="color:#a9a9a9;">
                    <option selected="" value="0">男</option>
                    <option value="1">女</option>
                </select>
            </div>
        </div>
    </div>
</div>
<div class="weui_cells_title">备注</div>
<div class="weui_cells weui_cells_form">
    <div class="weui_cell">
        <div class="weui_cell_bd weui_cell_primary">
            <textarea class="weui_textarea" name="remark" placeholder="备注" rows="3"></textarea>
            <div class="weui_textarea_counter"><span>0</span>/200</div>
        </div>
    </div>
</div>
<div class="weui_cells_title">账户抵扣</div>
<div class="weui_cells weui_cells_checkbox">
    <label class="weui_cell weui_check_label" for="s11">
        <div class="weui_cell_bd weui_cell_primary">
            <p>使用积分
                <span class="twoss" th:text="${mallIntegral}+'积分'">20积分</span>
                <span class="twossw" th:text="'减￥'+${mallIntegral/100}">减￥20.0</span>
            </p>
        </div>
        <div class="weui_cell_hd">
            <input type="checkbox" class="weui_check" name="mallIntegral" id="s11">
            <i class="weui_icon_checked"></i>
        </div>
    </label>
    <label class="weui_cell weui_check_label" for="s12">
        <div class="weui_cell_bd weui_cell_primary">
            <p>使用余额
                <span class="twoss" th:text="'￥'+${mallBalance}">￥20.0</span>
                <span class="twossw" th:text="'减￥'+${mallBalance}">减￥20.0</span>
            </p>
        </div>
        <div class="weui_cell_hd">
            <input type="checkbox" class="weui_check" name="mallBalance" id="s12">
            <i class="weui_icon_checked"></i>
        </div>
    </label>
    <label class="weui_cell weui_check_label" for="s13">
        <div class="weui_cell_bd weui_cell_primary">
            <p>使用小金库
                <span class="twoss" th:text="'￥'+${mallCoffers}">￥20.0</span>
                <span class="twossw" th:text="'减￥'+${mallCoffers}">减￥20.0</span>
            </p>
        </div>
        <div class="weui_cell_hd">
            <input type="checkbox" class="weui_check" name="mallCoffers" id="s13">
            <i class="weui_icon_checked"></i>
        </div>
    </label>
</div>
<p style="height: 60px;"></p>
<div class="xzlx-hot">
    <div class="item-action">
        <div class="moneypay">应付￥10.00</div>
        <div class="buy-now yuanjiaoo">
            <a id="submitBtn">提交采购订单</a>
        </div>
    </div>
</div>
<script src="http://resali.huobanplus.com/cdn/jquery/2.2.4/jquery.min.js"></script>
<script src="http://resali.huobanplus.com/cdn/jquery-weui/0.8.2/jquery-weui.min.js"></script>
<script type="text/javascript" src="js/w/swiper.animate1.0.2.min.js"></script>
<script src="http://resali.huobanplus.com/cdn/jquery-weui/0.8.2/swiper.min.js"></script>
<script type="text/javascript" th:inline="javascript">
    $(function () {
        var addOrderUrl = /*[[@{/wap/addOrderInfo}]]*/ '../../mock/httpJson.json';

        var toOrderInfoPage = /*[[@{/wap/toProcurementPayPage}]]*/ 'procurementPayPage.html';

        var goodId = /*[[${good.id}]]*/ 0;

        var routeId = /*[[${routeId}]]*/ 0;

        //剩余人数
        var amount = /*[[${amount}]]*/ 4;
        //成人价格
        var price = /*[[${good.price}]]*/ 10;
        //儿童价格
        var childPrice = /*[[${good.price*(childrenDiscount/10)}]]*/ 10;

        //商城小伙伴积分
        var mallIntegral = /*[[${mallIntegral}]]*/ 100;
        //商城小伙伴余额
        var mallBalance = /*[[${mallBalance}]]*/ 1;
        //商城小伙伴小金库
        var mallCoffers = /*[[${mallCoffers}]]*/ 1;

        //总金额
        var buyerMoney = price;

        $(".money").text('￥' + buyerMoney);
        $(".moneypay").text('应付￥' + buyerMoney);

        //成人减1
        $(".priceDecrease").click(function () {
            if (parseInt($("input[name='adult']").val()) > 0) {

                $("input[name='adult']").val(parseInt($("input[name='adult']").val()) - 1);
                buyerMoney =
                        parseInt($("input[name='adult']").val()) * price + parseInt($("input[name='children']").val()) * childPrice;
                if ((parseInt($("input[name='adult']").val()) == 0 && parseInt($("input[name='children']").val()) ==
                        0) || buyerMoney - moneyPay() < 0) {
                    $("input[type='checkbox']").prop("checked", false);
                }
                $(".money").text('￥' + buyerMoney);
                $('.adultDiv:last').remove();
                moneyPay();

            }
        });
        //成人加1
        $(".priceIncrease").click(function () {
            if (parseInt($("input[name='adult']").val()) + parseInt($("input[name='children']").val()) < amount) {
                $("input[name='adult']").val(parseInt($("input[name='adult']").val()) + 1)
                buyerMoney =
                        parseInt($("input[name='adult']").val()) * price + parseInt($("input[name='children']").val()) * childPrice;
                $(".itemTemplate").clone().removeClass("itemTemplate").addClass("adultDiv").appendTo(".items")
                        .show().find(".travelerType").val(0);
                $(".money").text('￥' + buyerMoney);
                moneyPay();
            }
        });

        //儿童减1
        $(".childPriceDecrease").click(function () {
            if (parseInt($("input[name='children']").val()) > 0) {
                $("input[name='children']").val(parseInt($("input[name='children']").val()) - 1)
                buyerMoney =
                        parseInt($("input[name='adult']").val()) * price + parseInt($("input[name='children']").val()) * childPrice;
                if ((parseInt($("input[name='adult']").val()) == 0 && parseInt($("input[name='children']").val()) ==
                        0) || buyerMoney - moneyPay() < 0) {
                    $("input[type='checkbox']").prop("checked", false);
                }
                $(".money").text('￥' + buyerMoney);
                $('.childrenDiv:last').remove();
                moneyPay();
            }
        });

        //儿童加1
        $(".childPriceIncrease").click(function () {
            if (parseInt($("input[name='adult']").val()) + parseInt($("input[name='children']").val()) < amount) {
                $("input[name='children']").val(parseInt($("input[name='children']").val()) + 1)
                $(".itemTemplate").clone().removeClass("itemTemplate").addClass("childrenDiv").appendTo(".items")
                        .show().find(".travelerType").val(1);
                buyerMoney =
                        parseInt($("input[name='adult']").val()) * price + parseInt($("input[name='children']").val()) * childPrice;
                $(".money").text('￥' + buyerMoney);
                moneyPay();
            }
        });

        //删除人员信息
        $(".items").on('click', '.delete', function () {
            $(this).parent().parent().remove();
            var travelerType = $(this).parent().parent().find(".travelerType").val();
            if (travelerType == 0) {
                $("input[name='adult']").val(parseInt($("input[name='adult']").val()) - 1)
            } else {
                $("input[name='children']").val(parseInt($("input[name='children']").val()) - 1)
            }
            buyerMoney =
                    parseInt($("input[name='adult']").val()) * price + parseInt($("input[name='children']").val()) * childPrice;

            if ((parseInt($("input[name='adult']").val()) == 0 && parseInt($("input[name='children']").val()) ==
                    0) || buyerMoney - moneyPay() < 0) {
                $("input[type='checkbox']").prop("checked", false);
            }
            amount -= 1;
            $(".money").text('￥' + buyerMoney);
            moneyPay();
        });


        $("input[type='checkbox']").change(function () {
            var name = $(this).attr("name");
            if ($(this).is(':checked')) {
                if (name == 'mallIntegral')
                    if (buyerMoney - moneyPay() <= 0) {
                        $.alert("不能再用积分了");
                        $(this).prop('checked', false)
                    }
                if (name == 'mallBalance')
                    if (buyerMoney - moneyPay() <= 0) {
                        $.alert("不能再用积分了");
                        $(this).prop('checked', false)
                    }
                if (name == 'mallCoffers')
                    if (buyerMoney - moneyPay() <= 0) {
                        $.alert("不能再用积分了");
                        $(this).prop('checked', false)
                    }

                moneyPay();
            } else {
                moneyPay();
            }
        });

        function moneyPay() {
            var mallNum = 0;
            $("input[type='checkbox']").each(function () {
                var name = $(this).attr("name");
                if ($(this).is(':checked')) {
                    if (name == 'mallIntegral')
                        mallNum += mallIntegral;
                    if (name == 'mallBalance')
                        mallNum += mallBalance;
                    if (name == 'mallCoffers')
                        mallNum += mallCoffers;
                }
            });
            $(".moneypay").text('应付￥' + (buyerMoney - mallNum));
            return mallNum;
        }


        $("#submitBtn").click(function () {
            if ($(".items .item").length < 1) {
                $.alert("请添加游客");
                return;
            }
            var travelers = new Array();
            var flag = false;
            $(".items .item").each(function () {
                var travelerType = parseInt($(this).find("input[name='travelerType']").val());
                var name = $(this).find("input[name='name']").val();
                var telPhone = $(this).find("input[name='telPhone']").val();
                var IDNo = $(this).find("input[name='IDNo']").val();
                var age = parseInt($(this).find("input[name='age']").val());
                var sex = parseInt($(this).find("select[name='sex']").val());
                if (name == '' || telPhone == '' || IDNo == '' || age <= 0) {
                    flag = true;
                    return;
                }
                var traveler = {
                    "travelerType": travelerType,
                    "name": name,
                    "telPhone": telPhone,
                    "IDNo": IDNo,
                    "age": age,
                    "sex": sex
                };
                travelers.push(traveler);
            });
            if (flag) {
                $.alert("请完善游客信息，姓名、电话、身份证号，年龄必填");
                return;
            }
            var data = {goodId: goodId, routeId: routeId, travelers: travelers};
            data.remark = $("textarea[name='remark']").val();
            if ($("input[name='mallIntegral']").checked) {
                data.mallIntegral = mallIntegral;
            }
            if ($("input[name='mallBalance']").checked) {
                data.mallBalance = mallBalance;
            }
            if ($("input[name='mallCoffers']").checked) {
                data.mallCoffers = mallCoffers;
            }
            $.ajax({
                url: addOrderUrl,
                method: "post",
                data: data,
                dataType: "json",
                success: function (data) {
                    window.location.href = toOrderInfoPage + "?orderId=" + data.orderId;
                },
                error: function (error) {
                    $.alert(error.msg)
                }
            });
        })
    });
</script>
</body>

</html>
